
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hockey Shootouts - Игра</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #1a2a3a;
            --secondary: #2d3e50;
            --accent: #e74c3c;
            --accent-light: #ff6b5b;
            --success: #27ae60;
            --warning: #f39c12;
            --text: #ffffff;
            --text-secondary: #bdc3c7;
            --card-bg: rgba(255, 255, 255, 0.1);
            --gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background: var(--gradient);
            color: var(--text);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            width: 100%;
            height: 70px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            background: rgba(0, 0, 0, 0.3);
            padding: 0 20px;
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
        }

        .app-title {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(45deg, #fff, var(--accent-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .balance {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.4);
            padding: 10px 18px;
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .game-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 20px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        .game-header {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .scoreboard {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
        }

        .player-score {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
        }

        .player-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            border: 2px solid var(--accent);
            overflow: hidden;
        }

        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .player-name {
            font-weight: bold;
            font-size: 14px;
            text-align: center;
        }

        .score-number {
            font-size: 36px;
            font-weight: bold;
            color: var(--accent-light);
        }

        .vs-divider {
            font-size: 32px;
            font-weight: bold;
            color: var(--accent-light);
        }

        .game-info {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 15px;
            align-items: center;
        }

        .timer {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .timer-number {
            font-size: 32px;
            font-weight: bold;
            color: var(--warning);
            text-shadow: 0 0 20px rgba(243, 156, 18, 0.5);
        }

        .timer-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .game-status {
            font-size: 16px;
            font-weight: bold;
        }

        .turn-indicator {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .game-field {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .field-title {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--accent-light);
        }

        .field-subtitle {
            text-align: center;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 25px;
        }

        .areas-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 15px;
            max-width: 350px;
            margin: 0 auto;
        }

        .area {
            height: 80px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .area:hover {
            border-color: var(--accent-light);
            background: rgba(231, 76, 60, 0.2);
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(231, 76, 60, 0.3);
        }

        .area.selected {
            background: linear-gradient(45deg, var(--warning), #f1c40f);
            border-color: var(--warning);
            color: #2c3e50;
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(243, 156, 18, 0.5);
        }

        .area.goal {
            background: linear-gradient(45deg, var(--success), #2ecc71);
            border-color: var(--success);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(46, 204, 113, 0.5);
        }

        .area.save {
            background: linear-gradient(45deg, var(--accent), var(--accent-light));
            border-color: var(--accent);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.5);
        }

        .area.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .game-actions {
            display: flex;
            justify-content: center;
            margin-top: 25px;
        }

        .btn {
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--accent), var(--accent-light));
            color: white;
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.6);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .waiting-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
        }

        .waiting-text {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }

        .loading {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-light);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .result-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .result-content {
            background: var(--secondary);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 350px;
            width: 90%;
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .result-icon {
            font-size: 80px;
            margin-bottom: 20px;
            text-shadow: 0 0 30px currentColor;
        }

        .result-text {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .result-description {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 25px;
        }

        .final-result-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            backdrop-filter: blur(15px);
        }

        .final-result-content {
            background: var(--secondary);
            padding: 50px;
            border-radius: 25px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            border: 3px solid var(--accent);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.7);
        }

        .final-icon {
            font-size: 100px;
            margin-bottom: 25px;
            text-shadow: 0 0 40px currentColor;
        }

        .final-text {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            z-index: 1002;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            display: none;
            font-weight: bold;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.4);
            color: white;
            border: none;
            border-radius: 50%;
            width: 55px;
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .back-btn:hover {
            background: rgba(0, 0, 0, 0.6);
            transform: scale(1.1);
        }

        .selected-count {
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
            color: var(--warning);
        }

        @media (max-width: 600px) {
            .game-container {
                padding: 15px;
            }
            
            .scoreboard {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .vs-divider {
                display: none;
            }
            
            .game-info {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .areas-grid {
                max-width: 300px;
                gap: 12px;
            }
            
            .area {
                height: 70px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <button class="back-btn" onclick="window.location.href='game.html'">←</button>

    <div class="notification" id="notification"></div>

    <div class="header">
        <div class="app-title">Hockey Shootouts</div>
        <div class="balance" id="balance">
            Клюшек: 0 🏒
        </div>
    </div>

    <div class="game-container">
        <div class="game-header">
            <div class="scoreboard">
                <div class="player-score">
                    <div class="player-avatar" id="player1-avatar">👤</div>
                    <div class="player-name" id="player1-name">Игрок 1</div>
                    <div class="score-number" id="player1-score">0</div>
                </div>
                
                <div class="vs-divider">:</div>
                
                <div class="player-score">
                    <div class="player-avatar" id="player2-avatar">👤</div>
                    <div class="player-name" id="player2-name">Игрок 2</div>
                    <div class="score-number" id="player2-score">0</div>
                </div>
            </div>

            <div class="game-info">
                <div class="game-status" id="game-status">Подготовка к игре...</div>
                
                <div class="timer">
                    <div class="timer-number" id="timer-display">10</div>
                    <div class="timer-label">секунд</div>
                </div>
                
                <div class="turn-indicator" id="turn-indicator"></div>
            </div>
        </div>

        <div class="game-field" id="game-field">
            <div id="shoot-phase" style="display: none;">
                <div class="field-title">⚽ Фаза атаки</div>
                <div class="field-subtitle">Выберите область для удара</div>
                <div class="areas-grid" id="goal-areas">
                    <div class="area" data-area="1">Верх<br>лево</div>
                    <div class="area" data-area="2">Верх<br>право</div>
                    <div class="area" data-area="3">Низ<br>лево</div>
                    <div class="area" data-area="4">Низ<br>право</div>
                </div>
            </div>

            <div id="defend-phase" style="display: none;">
                <div class="field-title">🛡️ Фаза защиты</div>
                <div class="field-subtitle">Выберите 2 области для блокировки</div>
                <div class="selected-count">Выбрано: <span id="selected-count">0</span>/2</div>
                <div class="areas-grid" id="defense-areas">
                    <div class="area" data-area="1">Верх<br>лево</div>
                    <div class="area" data-area="2">Верх<br>право</div>
                    <div class="area" data-area="3">Низ<br>лево</div>
                    <div class="area" data-area="4">Низ<br>право</div>
                </div>
            </div>

            <div id="waiting-phase">
                <div class="waiting-overlay" id="waiting-overlay">
                    <div class="loading"></div>
                    <div class="waiting-text" id="waiting-text">Ожидание соперника...</div>
                </div>
            </div>

            <div class="game-actions">
                <button class="btn btn-primary" id="confirm-action-btn" style="display: none;">
                    ✅ Подтвердить выбор
                </button>
            </div>
        </div>
    </div>

    <!-- Модальное окно результата раунда -->
    <div class="result-modal" id="result-modal">
        <div class="result-content">
            <div class="result-icon" id="result-icon">⚽</div>
            <div class="result-text" id="result-text">Результат</div>
            <div class="result-description" id="result-description">Описание</div>
            <button class="btn btn-primary" id="result-ok-btn">Продолжить</button>
        </div>
    </div>

    <!-- Модальное окно финального результата -->
    <div class="final-result-modal" id="final-result-modal">
        <div class="final-result-content">
            <div class="final-icon" id="final-icon">🏆</div>
            <div class="final-text" id="final-text">Игра завершена!</div>
            <div class="result-description" id="final-description">Описание</div>
            <button class="btn btn-primary" id="final-ok-btn">Вернуться в лобби</button>
        </div>
    </div>

    <script>
        // Конфигурация API
        const NOCODB_API = "https://app.nocodb.com/api/v1/db/data/weamcfo6/p27jdsmk69wuimh/meefo7wdwoh5mtv";
        const ROOM_API = "https://app.nocodb.com/api/v1/db/data/weamcfo6/p27jdsmk69wuimh/NEW_TABLE_ID"; // Замени NEW_TABLE_ID на ID таблицы game_room
        const NOCODB_KEY = "bocQfycJpJsTG_tbwEf8ma8E5rhoig0njMDXFWtJ";

        // Глобальные переменные
        const tg = window.Telegram.WebApp;
        let currentUser = null;
        let gameRoom = null;
        let roomId = null;
        let gameRefreshInterval = null;
        let timerInterval = null;
        let userBalance = 0;

        // Игровое состояние
        let gameState = {
            isMyTurn: false,
            phase: 'wait',
            selectedShootArea: null,
            selectedDefenseAreas: [],
            timeLeft: 10,
            roundNumber: 1,
            isPlayer1: false
        };

        // Инициализация пользователя
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            currentUser = tg.initDataUnsafe.user;
        } else {
            currentUser = {
                id: 12345,
                first_name: "Тестовый",
                last_name: "Пользователь",
                username: "test_user"
            };
        }

        // Получение ID комнаты из URL
        const urlParams = new URLSearchParams(window.location.search);
        roomId = urlParams.get('room');

        if (!roomId) {
            showNotification('❌ Некорректная ссылка на игру');
            setTimeout(() => window.location.href = 'game.html', 2000);
        }

        // Запуск игры
        init();

        async function init() {
            await loadUserBalance(currentUser.id);
            await loadRoom();
            if (gameRoom) {
                initializeGame();
                gameRefreshInterval = setInterval(refreshGame, 1000);
            }
        }

        // Загрузка баланса
        async function loadUserBalance(userId) {
            try {
                const response = await fetch(`${NOCODB_API}?where=(tg_user_id,eq,${userId})`, {
                    headers: { "xc-token": NOCODB_KEY }
                });
                const data = await response.json();
                if (data.list.length > 0) {
                    const balance = data.list[0].point || 0;
                    document.getElementById('balance').textContent = `Клюшек: ${balance} 🏒`;
                    userBalance = balance;
                    return balance;
                }
                userBalance = 0;
                return 0;
            } catch (error) {
                console.error("Ошибка при загрузке баланса:", error);
                return 0;
            }
        }

        // Загрузка данных комнаты
        async function loadRoom() {
            try {
                const response = await fetch(`${ROOM_API}/${roomId}`, {
                    headers: { "xc-token": NOCODB_KEY }
                });

                if (!response.ok) {
                    showNotification('❌ Комната не найдена');
                    setTimeout(() => window.location.href = 'game.html', 2000);
                    return;
                }

                gameRoom = await response.json();
                gameState.isPlayer1 = gameRoom.player1_id == currentUser.id;

                // Проверяем, что игрок участвует в этой игре
                if (gameRoom.player1_id != currentUser.id && gameRoom.player2_id != currentUser.id) {
                    showNotification('❌ Вы не участвуете в этой игре');
                    setTimeout(() => window.location.href = 'game.html', 2000);
                    return;
                }

                // Обновляем интерфейс
                updatePlayerInfo();

            } catch (error) {
                console.error("Ошибка при загрузке комнаты:", error);
                showNotification('❌ Ошибка загрузки игры');
                setTimeout(() => window.location.href = 'game.html', 2000);
            }
        }

        // Обновление информации об игроках
        function updatePlayerInfo() {
            document.getElementById('player1-name').textContent = gameRoom.player1_name || 'Игрок 1';
            document.getElementById('player2-name').textContent = gameRoom.player2_name || 'Игрок 2';
            
            // Аватары
            setPlayerAvatar('player1-avatar', gameRoom.player1_avatar);
            setPlayerAvatar('player2-avatar', gameRoom.player2_avatar);

            // Счет
            document.getElementById('player1-score').textContent = gameRoom.xp_p1 || 0;
            document.getElementById('player2-score').textContent = gameRoom.xp_p2 || 0;
        }

        // Установка аватара
        function setPlayerAvatar(elementId, avatarUrl) {
            const element = document.getElementById(elementId);
            if (avatarUrl) {
                element.innerHTML = `<img src="${avatarUrl}" alt="Аватар" onerror="this.parentElement.innerHTML='👤'">`;
            } else {
                element.innerHTML = '👤';
            }
        }

        // Инициализация игры
        function initializeGame() {
            updateGameState();
            startTimer();
        }

        // Обновление состояния игры
        function updateGameState() {
            const totalRounds = (gameRoom.xp_p1 || 0) + (gameRoom.xp_p2 || 0);
            const isPlayer1Turn = gameRoom.turn === 1;
            
            gameState.roundNumber = totalRounds + 1;
            gameState.timeLeft = gameRoom.sec || 10;

            // Определяем фазу игры
            if (gameRoom.send === null && gameRoom.block === null) {
                // Новый раунд - фаза удара
                gameState.phase = 'shoot';
                gameState.isMyTurn = (gameState.isPlayer1 && isPlayer1Turn) || (!gameState.isPlayer1 && !isPlayer1Turn);
            } else if (gameRoom.send !== null && gameRoom.block === null) {
                // Удар сделан, ждем защиту
                gameState.phase = 'defend';
                gameState.isMyTurn = (gameState.isPlayer1 && !isPlayer1Turn) || (!gameState.isPlayer1 && isPlayer1Turn);
            } else if (gameRoom.send !== null && gameRoom.block !== null) {
                // Обе фазы завершены, показываем результат
                gameState.phase = 'result';
                gameState.isMyTurn = false;
                showRoundResult();
                return;
            }

            updateUI();
        }

        // Обновление интерфейса
        function updateUI() {
            document.getElementById('timer-display').textContent = gameState.timeLeft;
            
            // Очищаем все фазы
            document.getElementById('shoot-phase').style.display = 'none';
            document.getElementById('defend-phase').style.display = 'none';
            document.getElementById('waiting-overlay').style.display = 'none';

            if (gameState.isMyTurn) {
                if (gameState.phase === 'shoot') {
                    document.getElementById('game-status').textContent = 'Ваш ход';
                    document.getElementById('turn-indicator').textContent = 'Выберите область для удара';
                    document.getElementById('shoot-phase').style.display = 'block';
                } else if (gameState.phase === 'defend') {
                    document.getElementById('game-status').textContent = 'Ваша защита';
                    document.getElementById('turn-indicator').textContent = 'Выберите 2 области для блокировки';
                    document.getElementById('defend-phase').style.display = 'block';
                }
            } else {
                document.getElementById('waiting-overlay').style.display = 'flex';
                if (gameState.phase === 'shoot') {
                    document.getElementById('game-status').textContent = 'Ход соперника';
                    document.getElementById('turn-indicator').textContent = 'Соперник выбирает область атаки';
                    document.getElementById('waiting-text').textContent = 'Соперник бьет...';
                } else if (gameState.phase === 'defend') {
                    document.getElementById('game-status').textContent = 'Защита соперника';
                    document.getElementById('turn-indicator').textContent = 'Соперник выбирает защиту';
                    document.getElementById('waiting-text').textContent = 'Соперник защищается...';
                }
            }

            clearSelections();
        }

        // Запуск таймера
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(async () => {
                if (gameState.timeLeft > 0) {
                    gameState.timeLeft--;
                    document.getElementById('timer-display').textContent = gameState.timeLeft;
                    
                    // Обновляем таймер в базе только если наш ход
                    if (gameState.isMyTurn) {
                        try {
                            await fetch(`${ROOM_API}/${roomId}`, {
                                method: 'PATCH',
                                headers: {
                                    'Content-Type': 'application/json',
                                    "xc-token": NOCODB_KEY
                                },
                                body: JSON.stringify({ sec: gameState.timeLeft })
                            });
                        } catch (error) {
                            console.error("Ошибка обновления таймера:", error);
                        }
                    }
                } else {
                    clearInterval(timerInterval);
                    if (gameState.isMyTurn) {
                        await handleTimeOut();
                    }
                }
            }, 1000);
        }

        // Обработка истечения времени
        async function handleTimeOut() {
            if (gameState.phase === 'shoot') {
                const randomArea = Math.floor(Math.random() * 4) + 1;
                gameState.selectedShootArea = randomArea;
                await submitShootAction();
            } else if (gameState.phase === 'defend') {
                const areas = [1, 2, 3, 4];
                const selectedAreas = [];
                for (let i = 0; i < 2; i++) {
                    const randomIndex = Math.floor(Math.random() * areas.length);
                    selectedAreas.push(areas[randomIndex]);
                    areas.splice(randomIndex, 1);
                }
                gameState.selectedDefenseAreas = selectedAreas;
                await submitDefendAction();
            }
        }

        // Обработчики выбора областей
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('area')) {
                const area = parseInt(e.target.getAttribute('data-area'));
                
                if (gameState.phase === 'shoot' && gameState.isMyTurn) {
                    selectShootArea(area);
                } else if (gameState.phase === 'defend' && gameState.isMyTurn) {
                    selectDefendArea(area);
                }
            }
        });

        // Выбор области для удара
        function selectShootArea(area) {
            clearSelections();
            gameState.selectedShootArea = area;
            
            const areaElement = document.querySelector(`#goal-areas [data-area="${area}"]`);
            areaElement.classList.add('selected');
            
            document.getElementById('confirm-action-btn').style.display = 'block';
        }

        // Выбор области для защиты
        function selectDefendArea(area) {
            const areaElement = document.querySelector(`#defense-areas [data-area="${area}"]`);
            
            if (areaElement.classList.contains('selected')) {
                areaElement.classList.remove('selected');
                gameState.selectedDefenseAreas = gameState.selectedDefenseAreas.filter(a => a !== area);
            } else {
                if (gameState.selectedDefenseAreas.length < 2) {
                    areaElement.classList.add('selected');
                    gameState.selectedDefenseAreas.push(area);
                }
            }

            document.getElementById('selected-count').textContent = gameState.selectedDefenseAreas.length;
            
            if (gameState.selectedDefenseAreas.length === 2) {
                document.getElementById('confirm-action-btn').style.display = 'block';
            } else {
                document.getElementById('confirm-action-btn').style.display = 'none';
            }
        }

        // Очистка выборов
        function clearSelections() {
            document.querySelectorAll('.area').forEach(area => {
                area.classList.remove('selected', 'goal', 'save');
            });
            gameState.selectedShootArea = null;
            gameState.selectedDefenseAreas = [];
            document.getElementById('selected-count').textContent = '0';
            document.getElementById('confirm-action-btn').style.display = 'none';
        }

        // Отправка действия удара
        async function submitShootAction() {
            try {
                await fetch(`${ROOM_API}/${roomId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        "xc-token": NOCODB_KEY
                    },
                    body: JSON.stringify({
                        send: gameState.selectedShootArea,
                        sec: 10,
                        turn: gameState.isPlayer1 ? 2 : 1
                    })
                });

                gameState.isMyTurn = false;
                updateUI();

            } catch (error) {
                console.error("Ошибка при отправке удара:", error);
                showNotification('❌ Ошибка отправки хода');
            }
        }

        // Отправка действия защиты
        async function submitDefendAction() {
            try {
                const blockValue = parseInt(gameState.selectedDefenseAreas.sort().join(''));
                
                await fetch(`${ROOM_API}/${roomId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        "xc-token": NOCODB_KEY
                    },
                    body: JSON.stringify({
                        block: blockValue
                    })
                });

                gameState.isMyTurn = false;
                updateUI();

            } catch (error) {
                console.error("Ошибка при отправке защиты:", error);
                showNotification('❌ Ошибка отправки хода');
            }
        }

        // Показ результата раунда
        function showRoundResult() {
            const shootArea = gameRoom.send;
            const blockAreas = gameRoom.block.toString().split('').map(n => parseInt(n));
            const isGoal = !blockAreas.includes(shootArea);

            // Визуальное отображение
            const goalAreas = document.querySelectorAll('#goal-areas .area, #defense-areas .area');
            goalAreas.forEach(area => {
                const areaNumber = parseInt(area.getAttribute('data-area'));
                if (areaNumber === shootArea) {
                    area.classList.add(isGoal ? 'goal' : 'save');
                }
                if (blockAreas.includes(areaNumber)) {
                    area.classList.add('selected');
                }
            });

            // Модальное окно
            const modal = document.getElementById('result-modal');
            const icon = document.getElementById('result-icon');
            const text = document.getElementById('result-text');
            const description = document.getElementById('result-description');

            if (isGoal) {
                icon.textContent = '⚽';
                icon.style.color = '#27ae60';
                text.textContent = 'ГОЛ!';
                text.style.color = '#27ae60';
                description.textContent = 'Удар прошел мимо защиты';
            } else {
                icon.textContent = '🛡️';
                icon.style.color = '#e74c3c';
                text.textContent = 'СЕЙВ!';
                text.style.color = '#e74c3c';
                description.textContent = 'Защитник блокировал удар';
            }

            modal.style.display = 'flex';
        }

        // Обновление игры
        async function refreshGame() {
            try {
                const response = await fetch(`${ROOM_API}/${roomId}`, {
                    headers: { "xc-token": NOCODB_KEY }
                });

                if (!response.ok) {
                    showNotification('🏆 Игра завершена');
                    setTimeout(() => window.location.href = 'game.html', 3000);
                    return;
                }

                const room = await response.json();
                if (!room || !room.Id) {
                    showNotification('🏆 Игра завершена');
                    setTimeout(() => window.location.href = 'game.html', 3000);
                    return;
                }

                const oldRoom = gameRoom;
                gameRoom = room;

                // Обновляем счет
                updatePlayerInfo();

                // Проверяем завершение игры
                if (room.xp_p1 >= 3 || room.xp_p2 >= 3) {
                    await endGame();
                    return;
                }

                // Проверяем изменения в состоянии
                const stateChanged = 
                    oldRoom.send !== room.send || 
                    oldRoom.block !== room.block ||
                    oldRoom.turn !== room.turn;

                if (stateChanged) {
                    updateGameState();
                    if (gameState.phase !== 'result') {
                        startTimer();
                    }
                }

                // Обновляем таймер если не наш ход
                if (!gameState.isMyTurn && room.sec !== gameState.timeLeft) {
                    gameState.timeLeft = room.sec || 0;
                    document.getElementById('timer-display').textContent = gameState.timeLeft;
                }

            } catch (error) {
                console.error("Ошибка при обновлении игры:", error);
            }
        }

        // Завершение игры
        async function endGame() {
            if (gameRefreshInterval) {
                clearInterval(gameRefreshInterval);
                gameRefreshInterval = null;
            }
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            const player1Wins = gameRoom.xp_p1 >= 3;
            const winnerId = player1Wins ? gameRoom.player1_id : gameRoom.player2_id;
            const winnerName = player1Wins ? gameRoom.player1_name : gameRoom.player2_name;
            const isWinner = winnerId == currentUser.id;
            const prize = 2; // Выигрыш 2 клюшки

            // Начисляем выигрыш
            if (isWinner) {
                const response = await fetch(`${NOCODB_API}?where=(tg_user_id,eq,${winnerId})`, {
                    headers: { "xc-token": NOCODB_KEY }
                });
                const data = await response.json();
                if (data.list.length > 0) {
                    await fetch(`${NOCODB_API}/${data.list[0].Id}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            "xc-token": NOCODB_KEY
                        },
                        body: JSON.stringify({
                            point: (data.list[0].point || 0) + prize
                        })
                    });
                }
                await loadUserBalance(currentUser.id);
            }

            // Сбрасываем комнату
            try {
                await fetch(`${ROOM_API}/${roomId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        "xc-token": NOCODB_KEY
                    },
                    body: JSON.stringify({
                        player1_id: null,
                        player1_name: null,
                        player1_avatar: null,
                        player2_id: null,
                        player2_name: null,
                        player2_avatar: null,
                        status: "empty",
                        xp_p1: 0,
                        xp_p2: 0,
                        sec: 10,
                        send: null,
                        block: null,
                        turn: 1
                    })
                });
            } catch (error) {
                console.error("Ошибка при сбросе комнаты:", error);
            }

            // Показываем финальный результат
            const modal = document.getElementById('final-result-modal');
            const icon = document.getElementById('final-icon');
            const text = document.getElementById('final-text');
            const description = document.getElementById('final-description');

            if (isWinner) {
                icon.textContent = '🏆';
                icon.style.color = '#f39c12';
                text.textContent = 'ПОБЕДА!';
                text.style.color = '#27ae60';
                description.textContent = `Вы выиграли ${prize} клюшек! Финальный счет: ${gameRoom.xp_p1}:${gameRoom.xp_p2}`;
            } else {
                icon.textContent = '💔';
                icon.style.color = '#e74c3c';
                text.textContent = 'ПОРАЖЕНИЕ';
                text.style.color = '#e74c3c';
                description.textContent = `Победитель: ${winnerName}. Финальный счет: ${gameRoom.xp_p1}:${gameRoom.xp_p2}`;
            }

            modal.style.display = 'flex';
        }

        // Показ уведомлений
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }

        // Обработчики событий
        document.getElementById('confirm-action-btn').addEventListener('click', async () => {
            if (gameState.phase === 'shoot' && gameState.selectedShootArea) {
                await submitShootAction();
            } else if (gameState.phase === 'defend' && gameState.selectedDefenseAreas.length === 2) {
                await submitDefendAction();
            }
        });

        document.getElementById('result-ok-btn').addEventListener('click', async () => {
            document.getElementById('result-modal').style.display = 'none';
            
            // Подготавливаем следующий раунд
            const shooterWon = !gameRoom.block.toString().split('').map(n => parseInt(n)).includes(gameRoom.send);
            const isPlayer1Shooter = gameRoom.turn === 1;
            
            let updateData = {
                send: null,
                block: null,
                sec: 10,
                turn: isPlayer1Shooter ? 2 : 1
            };

            if (shooterWon) {
                if (isPlayer1Shooter) {
                    updateData.xp_p1 = (gameRoom.xp_p1 || 0) + 1;
                } else {
                    updateData.xp_p2 = (gameRoom.xp_p2 || 0) + 1;
                }
            } else {
                if (isPlayer1Shooter) {
                    updateData.xp_p2 = (gameRoom.xp_p2 || 0) + 1;
                } else {
                    updateData.xp_p1 = (gameRoom.xp_p1 || 0) + 1;
                }
            }

            try {
                await fetch(`${ROOM_API}/${roomId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        "xc-token": NOCODB_KEY
                    },
                    body: JSON.stringify(updateData)
                });
            } catch (error) {
                console.error("Ошибка при сбросе раунда:", error);
            }
        });

        document.getElementById('final-ok-btn').addEventListener('click', () => {
            window.location.href = 'game.html';
        });

        // Обработка закрытия страницы
        window.addEventListener('beforeunload', () => {
            if (gameRefreshInterval) clearInterval(gameRefreshInterval);
            if (timerInterval) clearInterval(timerInterval);
        });
    </script>
</body>
</html>
