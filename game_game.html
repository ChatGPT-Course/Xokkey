
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hockey Shootouts - –ò–≥—Ä–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #1a2a3a;
            --secondary: #2d3e50;
            --accent: #e74c3c;
            --accent-light: #ff6b5b;
            --success: #27ae60;
            --warning: #f39c12;
            --text: #ffffff;
            --text-secondary: #bdc3c7;
            --card-bg: rgba(255, 255, 255, 0.1);
            --gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
        }

        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background: var(--gradient);
            color: var(--text);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            width: 100%;
            height: 70px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            background: rgba(0, 0, 0, 0.3);
            padding: 0 20px;
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
        }

        .app-title {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(45deg, #fff, var(--accent-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .balance {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            background: rgba(0, 0, 0, 0.4);
            padding: 10px 18px;
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .game-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 20px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        .game-header {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .scoreboard {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
        }

        .player-score {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
        }

        .player-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            border: 2px solid var(--accent);
            overflow: hidden;
        }

        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .player-name {
            font-weight: bold;
            font-size: 14px;
            text-align: center;
        }

        .score-number {
            font-size: 36px;
            font-weight: bold;
            color: var(--accent-light);
        }

        .vs-divider {
            font-size: 32px;
            font-weight: bold;
            color: var(--accent-light);
        }

        .game-info {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 15px;
            align-items: center;
        }

        .timer {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .timer-number {
            font-size: 32px;
            font-weight: bold;
            color: var(--warning);
            text-shadow: 0 0 20px rgba(243, 156, 18, 0.5);
        }

        .timer-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .game-status {
            font-size: 16px;
            font-weight: bold;
        }

        .turn-indicator {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .game-field {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .field-title {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--accent-light);
        }

        .field-subtitle {
            text-align: center;
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 25px;
        }

        .areas-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 15px;
            max-width: 350px;
            margin: 0 auto;
        }

        .area {
            height: 80px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .area:hover {
            border-color: var(--accent-light);
            background: rgba(231, 76, 60, 0.2);
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(231, 76, 60, 0.3);
        }

        .area.selected {
            background: linear-gradient(45deg, var(--warning), #f1c40f);
            border-color: var(--warning);
            color: #2c3e50;
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(243, 156, 18, 0.5);
        }

        .area.goal {
            background: linear-gradient(45deg, var(--success), #2ecc71);
            border-color: var(--success);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(46, 204, 113, 0.5);
        }

        .area.save {
            background: linear-gradient(45deg, var(--accent), var(--accent-light));
            border-color: var(--accent);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.5);
        }

        .area.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .game-actions {
            display: flex;
            justify-content: center;
            margin-top: 25px;
        }

        .btn {
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--accent), var(--accent-light));
            color: white;
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.6);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .waiting-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
        }

        .waiting-text {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }

        .loading {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-light);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .result-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .result-content {
            background: var(--secondary);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 350px;
            width: 90%;
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .result-icon {
            font-size: 80px;
            margin-bottom: 20px;
            text-shadow: 0 0 30px currentColor;
        }

        .result-text {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .result-description {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 25px;
        }

        .final-result-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            backdrop-filter: blur(15px);
        }

        .final-result-content {
            background: var(--secondary);
            padding: 50px;
            border-radius: 25px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            border: 3px solid var(--accent);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.7);
        }

        .final-icon {
            font-size: 100px;
            margin-bottom: 25px;
            text-shadow: 0 0 40px currentColor;
        }

        .final-text {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent);
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            z-index: 1002;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            display: none;
            font-weight: bold;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.4);
            color: white;
            border: none;
            border-radius: 50%;
            width: 55px;
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .back-btn:hover {
            background: rgba(0, 0, 0, 0.6);
            transform: scale(1.1);
        }

        .selected-count {
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
            color: var(--warning);
        }

        @media (max-width: 600px) {
            .game-container {
                padding: 15px;
            }
            
            .scoreboard {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .vs-divider {
                display: none;
            }
            
            .game-info {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .areas-grid {
                max-width: 300px;
                gap: 12px;
            }
            
            .area {
                height: 70px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <button class="back-btn" onclick="window.location.href='game.html'">‚Üê</button>

    <div class="notification" id="notification"></div>

    <div class="header">
        <div class="app-title">Hockey Shootouts</div>
        <div class="balance" id="balance">
            –ö–ª—é—à–µ–∫: 0 üèí
        </div>
    </div>

    <div class="game-container">
        <div class="game-header">
            <div class="scoreboard">
                <div class="player-score">
                    <div class="player-avatar" id="player1-avatar">üë§</div>
                    <div class="player-name" id="player1-name">–ò–≥—Ä–æ–∫ 1</div>
                    <div class="score-number" id="player1-score">0</div>
                </div>
                
                <div class="vs-divider">:</div>
                
                <div class="player-score">
                    <div class="player-avatar" id="player2-avatar">üë§</div>
                    <div class="player-name" id="player2-name">–ò–≥—Ä–æ–∫ 2</div>
                    <div class="score-number" id="player2-score">0</div>
                </div>
            </div>

            <div class="game-info">
                <div class="game-status" id="game-status">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∏–≥—Ä–µ...</div>
                
                <div class="timer">
                    <div class="timer-number" id="timer-display">10</div>
                    <div class="timer-label">—Å–µ–∫—É–Ω–¥</div>
                </div>
                
                <div class="turn-indicator" id="turn-indicator"></div>
            </div>
        </div>

        <div class="game-field" id="game-field">
            <div id="shoot-phase" style="display: none;">
                <div class="field-title">‚öΩ –§–∞–∑–∞ –∞—Ç–∞–∫–∏</div>
                <div class="field-subtitle">–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å –¥–ª—è —É–¥–∞—Ä–∞</div>
                <div class="areas-grid" id="goal-areas">
                    <div class="area" data-area="1">–í–µ—Ä—Ö<br>–ª–µ–≤–æ</div>
                    <div class="area" data-area="2">–í–µ—Ä—Ö<br>–ø—Ä–∞–≤–æ</div>
                    <div class="area" data-area="3">–ù–∏–∑<br>–ª–µ–≤–æ</div>
                    <div class="area" data-area="4">–ù–∏–∑<br>–ø—Ä–∞–≤–æ</div>
                </div>
            </div>

            <div id="defend-phase" style="display: none;">
                <div class="field-title">üõ°Ô∏è –§–∞–∑–∞ –∑–∞—â–∏—Ç—ã</div>
                <div class="field-subtitle">–í—ã–±–µ—Ä–∏—Ç–µ 2 –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏</div>
                <div class="selected-count">–í—ã–±—Ä–∞–Ω–æ: <span id="selected-count">0</span>/2</div>
                <div class="areas-grid" id="defense-areas">
                    <div class="area" data-area="1">–í–µ—Ä—Ö<br>–ª–µ–≤–æ</div>
                    <div class="area" data-area="2">–í–µ—Ä—Ö<br>–ø—Ä–∞–≤–æ</div>
                    <div class="area" data-area="3">–ù–∏–∑<br>–ª–µ–≤–æ</div>
                    <div class="area" data-area="4">–ù–∏–∑<br>–ø—Ä–∞–≤–æ</div>
                </div>
            </div>

            <div id="waiting-phase">
                <div class="waiting-overlay" id="waiting-overlay">
                    <div class="loading"></div>
                    <div class="waiting-text" id="waiting-text">–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...</div>
                </div>
            </div>

            <div class="game-actions">
                <button class="btn btn-primary" id="confirm-action-btn" style="display: none;">
                    ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ä–∞—É–Ω–¥–∞ -->
    <div class="result-modal" id="result-modal">
        <div class="result-content">
            <div class="result-icon" id="result-icon">‚öΩ</div>
            <div class="result-text" id="result-text">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
            <div class="result-description" id="result-description">–û–ø–∏—Å–∞–Ω–∏–µ</div>
            <button class="btn btn-primary" id="result-ok-btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
    <div class="final-result-modal" id="final-result-modal">
        <div class="final-result-content">
            <div class="final-icon" id="final-icon">üèÜ</div>
            <div class="final-text" id="final-text">–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</div>
            <div class="result-description" id="final-description">–û–ø–∏—Å–∞–Ω–∏–µ</div>
            <button class="btn btn-primary" id="final-ok-btn">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ª–æ–±–±–∏</button>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API
        const NOCODB_API = "https://app.nocodb.com/api/v1/db/data/weamcfo6/p27jdsmk69wuimh/meefo7wdwoh5mtv";
        const ROOM_API = "https://app.nocodb.com/api/v1/db/data/weamcfo6/p27jdsmk69wuimh/NEW_TABLE_ID"; // –ó–∞–º–µ–Ω–∏ NEW_TABLE_ID –Ω–∞ ID —Ç–∞–±–ª–∏—Ü—ã game_room
        const NOCODB_KEY = "bocQfycJpJsTG_tbwEf8ma8E5rhoig0njMDXFWtJ";

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        const tg = window.Telegram.WebApp;
        let currentUser = null;
        let gameRoom = null;
        let roomId = null;
        let gameRefreshInterval = null;
        let timerInterval = null;
        let userBalance = 0;

        // –ò–≥—Ä–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        let gameState = {
            isMyTurn: false,
            phase: 'wait',
            selectedShootArea: null,
            selectedDefenseAreas: [],
            timeLeft: 10,
            roundNumber: 1,
            isPlayer1: false
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            currentUser = tg.initDataUnsafe.user;
        } else {
            currentUser = {
                id: 12345,
                first_name: "–¢–µ—Å—Ç–æ–≤—ã–π",
                last_name: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
                username: "test_user"
            };
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ ID –∫–æ–º–Ω–∞—Ç—ã –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        roomId = urlParams.get('room');

        if (!roomId) {
            showNotification('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏–≥—Ä—É');
            setTimeout(() => window.location.href = 'game.html', 2000);
        }

        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
        init();

        async function init() {
            await loadUserBalance(currentUser.id);
            await loadRoom();
            if (gameRoom) {
                initializeGame();
                gameRefreshInterval = setInterval(refreshGame, 1000);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞
        async function loadUserBalance(userId) {
            try {
                const response = await fetch(`${NOCODB_API}?where=(tg_user_id,eq,${userId})`, {
                    headers: { "xc-token": NOCODB_KEY }
                });
                const data = await response.json();
                if (data.list.length > 0) {
                    const balance = data.list[0].point || 0;
                    document.getElementById('balance').textContent = `–ö–ª—é—à–µ–∫: ${balance} üèí`;
                    userBalance = balance;
                    return balance;
                }
                userBalance = 0;
                return 0;
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –±–∞–ª–∞–Ω—Å–∞:", error);
                return 0;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç—ã
        async function loadRoom() {
            try {
                const response = await fetch(`${ROOM_API}/${roomId}`, {
                    headers: { "xc-token": NOCODB_KEY }
                });

                if (!response.ok) {
                    showNotification('‚ùå –ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    setTimeout(() => window.location.href = 'game.html', 2000);
                    return;
                }

                gameRoom = await response.json();
                gameState.isPlayer1 = gameRoom.player1_id == currentUser.id;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–≥—Ä–æ–∫ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ —ç—Ç–æ–π –∏–≥—Ä–µ
                if (gameRoom.player1_id != currentUser.id && gameRoom.player2_id != currentUser.id) {
                    showNotification('‚ùå –í—ã –Ω–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ —ç—Ç–æ–π –∏–≥—Ä–µ');
                    setTimeout(() => window.location.href = 'game.html', 2000);
                    return;
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                updatePlayerInfo();

            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–º–Ω–∞—Ç—ã:", error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä—ã');
                setTimeout(() => window.location.href = 'game.html', 2000);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∏–≥—Ä–æ–∫–∞—Ö
        function updatePlayerInfo() {
            document.getElementById('player1-name').textContent = gameRoom.player1_name || '–ò–≥—Ä–æ–∫ 1';
            document.getElementById('player2-name').textContent = gameRoom.player2_name || '–ò–≥—Ä–æ–∫ 2';
            
            // –ê–≤–∞—Ç–∞—Ä—ã
            setPlayerAvatar('player1-avatar', gameRoom.player1_avatar);
            setPlayerAvatar('player2-avatar', gameRoom.player2_avatar);

            // –°—á–µ—Ç
            document.getElementById('player1-score').textContent = gameRoom.xp_p1 || 0;
            document.getElementById('player2-score').textContent = gameRoom.xp_p2 || 0;
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞
        function setPlayerAvatar(elementId, avatarUrl) {
            const element = document.getElementById(elementId);
            if (avatarUrl) {
                element.innerHTML = `<img src="${avatarUrl}" alt="–ê–≤–∞—Ç–∞—Ä" onerror="this.parentElement.innerHTML='üë§'">`;
            } else {
                element.innerHTML = 'üë§';
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        function initializeGame() {
            updateGameState();
            startTimer();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
        function updateGameState() {
            const totalRounds = (gameRoom.xp_p1 || 0) + (gameRoom.xp_p2 || 0);
            const isPlayer1Turn = gameRoom.turn === 1;
            
            gameState.roundNumber = totalRounds + 1;
            gameState.timeLeft = gameRoom.sec || 10;

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–∞–∑—É –∏–≥—Ä—ã
            if (gameRoom.send === null && gameRoom.block === null) {
                // –ù–æ–≤—ã–π —Ä–∞—É–Ω–¥ - —Ñ–∞–∑–∞ —É–¥–∞—Ä–∞
                gameState.phase = 'shoot';
                gameState.isMyTurn = (gameState.isPlayer1 && isPlayer1Turn) || (!gameState.isPlayer1 && !isPlayer1Turn);
            } else if (gameRoom.send !== null && gameRoom.block === null) {
                // –£–¥–∞—Ä —Å–¥–µ–ª–∞–Ω, –∂–¥–µ–º –∑–∞—â–∏—Ç—É
                gameState.phase = 'defend';
                gameState.isMyTurn = (gameState.isPlayer1 && !isPlayer1Turn) || (!gameState.isPlayer1 && isPlayer1Turn);
            } else if (gameRoom.send !== null && gameRoom.block !== null) {
                // –û–±–µ —Ñ–∞–∑—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                gameState.phase = 'result';
                gameState.isMyTurn = false;
                showRoundResult();
                return;
            }

            updateUI();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUI() {
            document.getElementById('timer-display').textContent = gameState.timeLeft;
            
            // –û—á–∏—â–∞–µ–º –≤—Å–µ —Ñ–∞–∑—ã
            document.getElementById('shoot-phase').style.display = 'none';
            document.getElementById('defend-phase').style.display = 'none';
            document.getElementById('waiting-overlay').style.display = 'none';

            if (gameState.isMyTurn) {
                if (gameState.phase === 'shoot') {
                    document.getElementById('game-status').textContent = '–í–∞—à —Ö–æ–¥';
                    document.getElementById('turn-indicator').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å –¥–ª—è —É–¥–∞—Ä–∞';
                    document.getElementById('shoot-phase').style.display = 'block';
                } else if (gameState.phase === 'defend') {
                    document.getElementById('game-status').textContent = '–í–∞—à–∞ –∑–∞—â–∏—Ç–∞';
                    document.getElementById('turn-indicator').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ 2 –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏';
                    document.getElementById('defend-phase').style.display = 'block';
                }
            } else {
                document.getElementById('waiting-overlay').style.display = 'flex';
                if (gameState.phase === 'shoot') {
                    document.getElementById('game-status').textContent = '–•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞';
                    document.getElementById('turn-indicator').textContent = '–°–æ–ø–µ—Ä–Ω–∏–∫ –≤—ã–±–∏—Ä–∞–µ—Ç –æ–±–ª–∞—Å—Ç—å –∞—Ç–∞–∫–∏';
                    document.getElementById('waiting-text').textContent = '–°–æ–ø–µ—Ä–Ω–∏–∫ –±—å–µ—Ç...';
                } else if (gameState.phase === 'defend') {
                    document.getElementById('game-status').textContent = '–ó–∞—â–∏—Ç–∞ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞';
                    document.getElementById('turn-indicator').textContent = '–°–æ–ø–µ—Ä–Ω–∏–∫ –≤—ã–±–∏—Ä–∞–µ—Ç –∑–∞—â–∏—Ç—É';
                    document.getElementById('waiting-text').textContent = '–°–æ–ø–µ—Ä–Ω–∏–∫ –∑–∞—â–∏—â–∞–µ—Ç—Å—è...';
                }
            }

            clearSelections();
        }

        // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(async () => {
                if (gameState.timeLeft > 0) {
                    gameState.timeLeft--;
                    document.getElementById('timer-display').textContent = gameState.timeLeft;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä –≤ –±–∞–∑–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∞—à —Ö–æ–¥
                    if (gameState.isMyTurn) {
                        try {
                            await fetch(`${ROOM_API}/${roomId}`, {
                                method: 'PATCH',
                                headers: {
                                    'Content-Type': 'application/json',
                                    "xc-token": NOCODB_KEY
                                },
                                body: JSON.stringify({ sec: gameState.timeLeft })
                            });
                        } catch (error) {
                            console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞:", error);
                        }
                    }
                } else {
                    clearInterval(timerInterval);
                    if (gameState.isMyTurn) {
                        await handleTimeOut();
                    }
                }
            }, 1000);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
        async function handleTimeOut() {
            if (gameState.phase === 'shoot') {
                const randomArea = Math.floor(Math.random() * 4) + 1;
                gameState.selectedShootArea = randomArea;
                await submitShootAction();
            } else if (gameState.phase === 'defend') {
                const areas = [1, 2, 3, 4];
                const selectedAreas = [];
                for (let i = 0; i < 2; i++) {
                    const randomIndex = Math.floor(Math.random() * areas.length);
                    selectedAreas.push(areas[randomIndex]);
                    areas.splice(randomIndex, 1);
                }
                gameState.selectedDefenseAreas = selectedAreas;
                await submitDefendAction();
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–±–æ—Ä–∞ –æ–±–ª–∞—Å—Ç–µ–π
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('area')) {
                const area = parseInt(e.target.getAttribute('data-area'));
                
                if (gameState.phase === 'shoot' && gameState.isMyTurn) {
                    selectShootArea(area);
                } else if (gameState.phase === 'defend' && gameState.isMyTurn) {
                    selectDefendArea(area);
                }
            }
        });

        // –í—ã–±–æ—Ä –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è —É–¥–∞—Ä–∞
        function selectShootArea(area) {
            clearSelections();
            gameState.selectedShootArea = area;
            
            const areaElement = document.querySelector(`#goal-areas [data-area="${area}"]`);
            areaElement.classList.add('selected');
            
            document.getElementById('confirm-action-btn').style.display = 'block';
        }

        // –í—ã–±–æ—Ä –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è –∑–∞—â–∏—Ç—ã
        function selectDefendArea(area) {
            const areaElement = document.querySelector(`#defense-areas [data-area="${area}"]`);
            
            if (areaElement.classList.contains('selected')) {
                areaElement.classList.remove('selected');
                gameState.selectedDefenseAreas = gameState.selectedDefenseAreas.filter(a => a !== area);
            } else {
                if (gameState.selectedDefenseAreas.length < 2) {
                    areaElement.classList.add('selected');
                    gameState.selectedDefenseAreas.push(area);
                }
            }

            document.getElementById('selected-count').textContent = gameState.selectedDefenseAreas.length;
            
            if (gameState.selectedDefenseAreas.length === 2) {
                document.getElementById('confirm-action-btn').style.display = 'block';
            } else {
                document.getElementById('confirm-action-btn').style.display = 'none';
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ –≤—ã–±–æ—Ä–æ–≤
        function clearSelections() {
            document.querySelectorAll('.area').forEach(area => {
                area.classList.remove('selected', 'goal', 'save');
            });
            gameState.selectedShootArea = null;
            gameState.selectedDefenseAreas = [];
            document.getElementById('selected-count').textContent = '0';
            document.getElementById('confirm-action-btn').style.display = 'none';
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è —É–¥–∞—Ä–∞
        async function submitShootAction() {
            try {
                await fetch(`${ROOM_API}/${roomId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        "xc-token": NOCODB_KEY
                    },
                    body: JSON.stringify({
                        send: gameState.selectedShootArea,
                        sec: 10,
                        turn: gameState.isPlayer1 ? 2 : 1
                    })
                });

                gameState.isMyTurn = false;
                updateUI();

            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–¥–∞—Ä–∞:", error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ö–æ–¥–∞');
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è –∑–∞—â–∏—Ç—ã
        async function submitDefendAction() {
            try {
                const blockValue = parseInt(gameState.selectedDefenseAreas.sort().join(''));
                
                await fetch(`${ROOM_API}/${roomId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        "xc-token": NOCODB_KEY
                    },
                    body: JSON.stringify({
                        block: blockValue
                    })
                });

                gameState.isMyTurn = false;
                updateUI();

            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—â–∏—Ç—ã:", error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ö–æ–¥–∞');
            }
        }

        // –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ä–∞—É–Ω–¥–∞
        function showRoundResult() {
            const shootArea = gameRoom.send;
            const blockAreas = gameRoom.block.toString().split('').map(n => parseInt(n));
            const isGoal = !blockAreas.includes(shootArea);

            // –í–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            const goalAreas = document.querySelectorAll('#goal-areas .area, #defense-areas .area');
            goalAreas.forEach(area => {
                const areaNumber = parseInt(area.getAttribute('data-area'));
                if (areaNumber === shootArea) {
                    area.classList.add(isGoal ? 'goal' : 'save');
                }
                if (blockAreas.includes(areaNumber)) {
                    area.classList.add('selected');
                }
            });

            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = document.getElementById('result-modal');
            const icon = document.getElementById('result-icon');
            const text = document.getElementById('result-text');
            const description = document.getElementById('result-description');

            if (isGoal) {
                icon.textContent = '‚öΩ';
                icon.style.color = '#27ae60';
                text.textContent = '–ì–û–õ!';
                text.style.color = '#27ae60';
                description.textContent = '–£–¥–∞—Ä –ø—Ä–æ—à–µ–ª –º–∏–º–æ –∑–∞—â–∏—Ç—ã';
            } else {
                icon.textContent = 'üõ°Ô∏è';
                icon.style.color = '#e74c3c';
                text.textContent = '–°–ï–ô–í!';
                text.style.color = '#e74c3c';
                description.textContent = '–ó–∞—â–∏—Ç–Ω–∏–∫ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª —É–¥–∞—Ä';
            }

            modal.style.display = 'flex';
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥—Ä—ã
        async function refreshGame() {
            try {
                const response = await fetch(`${ROOM_API}/${roomId}`, {
                    headers: { "xc-token": NOCODB_KEY }
                });

                if (!response.ok) {
                    showNotification('üèÜ –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                    setTimeout(() => window.location.href = 'game.html', 3000);
                    return;
                }

                const room = await response.json();
                if (!room || !room.Id) {
                    showNotification('üèÜ –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                    setTimeout(() => window.location.href = 'game.html', 3000);
                    return;
                }

                const oldRoom = gameRoom;
                gameRoom = room;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç
                updatePlayerInfo();

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–≥—Ä—ã
                if (room.xp_p1 >= 3 || room.xp_p2 >= 3) {
                    await endGame();
                    return;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
                const stateChanged = 
                    oldRoom.send !== room.send || 
                    oldRoom.block !== room.block ||
                    oldRoom.turn !== room.turn;

                if (stateChanged) {
                    updateGameState();
                    if (gameState.phase !== 'result') {
                        startTimer();
                    }
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º–µ—Ä –µ—Å–ª–∏ –Ω–µ –Ω–∞—à —Ö–æ–¥
                if (!gameState.isMyTurn && room.sec !== gameState.timeLeft) {
                    gameState.timeLeft = room.sec || 0;
                    document.getElementById('timer-display').textContent = gameState.timeLeft;
                }

            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–≥—Ä—ã:", error);
            }
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–≥—Ä—ã
        async function endGame() {
            if (gameRefreshInterval) {
                clearInterval(gameRefreshInterval);
                gameRefreshInterval = null;
            }
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            const player1Wins = gameRoom.xp_p1 >= 3;
            const winnerId = player1Wins ? gameRoom.player1_id : gameRoom.player2_id;
            const winnerName = player1Wins ? gameRoom.player1_name : gameRoom.player2_name;
            const isWinner = winnerId == currentUser.id;
            const prize = 2; // –í—ã–∏–≥—Ä—ã—à 2 –∫–ª—é—à–∫–∏

            // –ù–∞—á–∏—Å–ª—è–µ–º –≤—ã–∏–≥—Ä—ã—à
            if (isWinner) {
                const response = await fetch(`${NOCODB_API}?where=(tg_user_id,eq,${winnerId})`, {
                    headers: { "xc-token": NOCODB_KEY }
                });
                const data = await response.json();
                if (data.list.length > 0) {
                    await fetch(`${NOCODB_API}/${data.list[0].Id}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            "xc-token": NOCODB_KEY
                        },
                        body: JSON.stringify({
                            point: (data.list[0].point || 0) + prize
                        })
                    });
                }
                await loadUserBalance(currentUser.id);
            }

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–æ–º–Ω–∞—Ç—É
            try {
                await fetch(`${ROOM_API}/${roomId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        "xc-token": NOCODB_KEY
                    },
                    body: JSON.stringify({
                        player1_id: null,
                        player1_name: null,
                        player1_avatar: null,
                        player2_id: null,
                        player2_name: null,
                        player2_avatar: null,
                        status: "empty",
                        xp_p1: 0,
                        xp_p2: 0,
                        sec: 10,
                        send: null,
                        block: null,
                        turn: 1
                    })
                });
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –∫–æ–º–Ω–∞—Ç—ã:", error);
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            const modal = document.getElementById('final-result-modal');
            const icon = document.getElementById('final-icon');
            const text = document.getElementById('final-text');
            const description = document.getElementById('final-description');

            if (isWinner) {
                icon.textContent = 'üèÜ';
                icon.style.color = '#f39c12';
                text.textContent = '–ü–û–ë–ï–î–ê!';
                text.style.color = '#27ae60';
                description.textContent = `–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ ${prize} –∫–ª—é—à–µ–∫! –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—á–µ—Ç: ${gameRoom.xp_p1}:${gameRoom.xp_p2}`;
            } else {
                icon.textContent = 'üíî';
                icon.style.color = '#e74c3c';
                text.textContent = '–ü–û–†–ê–ñ–ï–ù–ò–ï';
                text.style.color = '#e74c3c';
                description.textContent = `–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${winnerName}. –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—á–µ—Ç: ${gameRoom.xp_p1}:${gameRoom.xp_p2}`;
            }

            modal.style.display = 'flex';
        }

        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('confirm-action-btn').addEventListener('click', async () => {
            if (gameState.phase === 'shoot' && gameState.selectedShootArea) {
                await submitShootAction();
            } else if (gameState.phase === 'defend' && gameState.selectedDefenseAreas.length === 2) {
                await submitDefendAction();
            }
        });

        document.getElementById('result-ok-btn').addEventListener('click', async () => {
            document.getElementById('result-modal').style.display = 'none';
            
            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥
            const shooterWon = !gameRoom.block.toString().split('').map(n => parseInt(n)).includes(gameRoom.send);
            const isPlayer1Shooter = gameRoom.turn === 1;
            
            let updateData = {
                send: null,
                block: null,
                sec: 10,
                turn: isPlayer1Shooter ? 2 : 1
            };

            if (shooterWon) {
                if (isPlayer1Shooter) {
                    updateData.xp_p1 = (gameRoom.xp_p1 || 0) + 1;
                } else {
                    updateData.xp_p2 = (gameRoom.xp_p2 || 0) + 1;
                }
            } else {
                if (isPlayer1Shooter) {
                    updateData.xp_p2 = (gameRoom.xp_p2 || 0) + 1;
                } else {
                    updateData.xp_p1 = (gameRoom.xp_p1 || 0) + 1;
                }
            }

            try {
                await fetch(`${ROOM_API}/${roomId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        "xc-token": NOCODB_KEY
                    },
                    body: JSON.stringify(updateData)
                });
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —Ä–∞—É–Ω–¥–∞:", error);
            }
        });

        document.getElementById('final-ok-btn').addEventListener('click', () => {
            window.location.href = 'game.html';
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            if (gameRefreshInterval) clearInterval(gameRefreshInterval);
            if (timerInterval) clearInterval(timerInterval);
        });
    </script>
</body>
</html>
