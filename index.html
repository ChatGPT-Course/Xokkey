
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hockey Shootouts</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            color: white;
            padding-top: 70px;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(44, 62, 80, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            box-shadow: 0 2px 20px rgba(0,0,0,0.3);
        }

        .header-title {
            font-size: 1.8rem;
            font-weight: bold;
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: right;
            margin-right: 20px;
            flex: 1;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: calc(100vh - 70px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .user-avatar {
            width: 120px;
            height: 120px;
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px auto;
            font-size: 4rem;
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.3);
            color: white;
        }

        .currency-display {
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(52, 73, 94, 0.8);
            padding: 12px 20px;
            border-radius: 25px;
            margin: 20px auto;
            width: fit-content;
            font-size: 1.2rem;
            font-weight: 600;
            backdrop-filter: blur(5px);
            position: relative;
            overflow: hidden;
        }

        .currency-display.loading::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .currency-display .stick-icon {
            margin-left: 8px;
            font-size: 1.4rem;
        }

        .btn {
            display: block;
            width: 100%;
            max-width: 300px;
            padding: 15px 20px;
            border: none;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            margin: 12px 0;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(231, 76, 60, 0.4);
        }

        .btn-secondary {
            background: rgba(52, 73, 94, 0.8);
            color: #ecf0f1;
            border: 2px solid rgba(236, 240, 241, 0.3);
            backdrop-filter: blur(5px);
        }

        .btn-secondary:hover {
            background: rgba(52, 73, 94, 1);
            border-color: rgba(236, 240, 241, 0.5);
            transform: translateY(-1px);
        }

        .menu-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
            width: 100%;
            max-width: 300px;
        }

        .version {
            margin-top: 30px;
            font-size: 0.9rem;
            color: rgba(236, 240, 241, 0.6);
            text-align: center;
        }

        .user-info {
            margin-top: 20px;
            font-size: 0.9rem;
            color: rgba(236, 240, 241, 0.8);
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">Hockey Shootouts</div>
    </div>

    <div class="container">
        <div class="user-avatar" id="userAvatar">
            <img id="userPhoto" style="display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" alt="User Photo">
            <span id="userInitial">üë§</span>
        </div>
        
        <div class="currency-display">
            <span>–ö–ª—é—à–µ–∫: <span id="userMoney">0</span></span>
            <span class="stick-icon">üèí</span>
        </div>

        <a href="game.html" class="btn btn-primary">
            –ò–≥—Ä–∞—Ç—å
        </a>

        <a href="profile.html" class="btn btn-secondary">
            –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
        </a>

        <div class="menu-grid">
            <a href="craft.html" class="btn btn-secondary">
                –ö—Ä–∞—Ñ—Ç
            </a>
            <a href="obmen.html" class="btn btn-secondary">
                –û–±–º–µ–Ω
            </a>
        </div>

        <div class="version">Hockey Shootouts V(b-1.0)</div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è Cloudflare D1 API
        const config = {
            baseUrl: 'https://hockey-d1-api.egorspirin10.workers.dev', // URL –≤–∞—à–µ–≥–æ D1 API worker'–∞
            timeout: 10000,
            retryDelay: 200,
            maxRetries: 3,
            cacheTimeout: 30000 // 30 —Å–µ–∫—É–Ω–¥ –∫—ç—à
        };

        // –ö—ç—à –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
        const requestCache = new Map();
        const pendingRequests = new Map();
        
        let tg = window.Telegram.WebApp;
        let userData = null;
        let isInitialized = false;
        

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å D1 API
        async function makeApiRequest(endpoint, options = {}) {
            const cacheKey = `${endpoint}_${JSON.stringify(options)}`;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à –¥–ª—è GET –∑–∞–ø—Ä–æ—Å–æ–≤
            if (options.method !== 'POST' && options.method !== 'PUT' && options.method !== 'DELETE') {
                const cached = requestCache.get(cacheKey);
                if (cached && Date.now() - cached.timestamp < config.cacheTimeout) {
                    return cached.data;
                }
            }

            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
            if (pendingRequests.has(cacheKey)) {
                return await pendingRequests.get(cacheKey);
            }

            const requestPromise = executeRequest(endpoint, options);
            pendingRequests.set(cacheKey, requestPromise);

            try {
                const result = await requestPromise;
                
                // –ö—ç—à–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—ã–µ GET –∑–∞–ø—Ä–æ—Å—ã
                if (options.method !== 'POST' && options.method !== 'PUT' && options.method !== 'DELETE') {
                    requestCache.set(cacheKey, {
                        data: result,
                        timestamp: Date.now()
                    });
                }
                
                return result;
            } finally {
                pendingRequests.delete(cacheKey);
            }
        }

        async function executeRequest(endpoint, options = {}) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), config.timeout);

            try {
                const url = `${config.baseUrl}${endpoint}`;
                
                const requestOptions = {
                    ...options,
                    signal: controller.signal,
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache',
                        ...options.headers
                    }
                };

                const response = await fetch(url, requestOptions);
                clearTimeout(timeoutId);

                if (response.ok) {
                    return await response.json();
                }

                // –ü—Ä–∏ –æ—à–∏–±–∫–µ —Ä–µ—Ç—Ä–∞–π
                if (response.status === 429 || response.status >= 500) {
                    await new Promise(resolve => setTimeout(resolve, config.retryDelay));
                    return await executeRequest(endpoint, options);
                }

                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                
            } catch (error) {
                clearTimeout(timeoutId);
                
                if (error.name === 'AbortError') {
                    throw new Error('Request timeout');
                }
                
                throw error;
            }
        }

        // –î–µ–±–∞—É–Ω—Å –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å cookie
        function setCookie(name, value, days = 365) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
        }

        // –ü–æ–ª—É—á–∏—Ç—å cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram WebApp
        function getTelegramUserData() {
            try {
                tg.expand();

                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    const user = tg.initDataUnsafe.user;
                    return {
                        id: user.id.toString(),
                        username: user.username || '',
                        first_name: user.first_name || '',
                        last_name: user.last_name || '',
                        display_name: `${user.first_name || ''} ${user.last_name || ''}`.trim() || '–ò–≥—Ä–æ–∫',
                        language_code: user.language_code || 'ru'
                    };
                }

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –µ—Å—Ç—å
                const savedUserId = getCookie('tg_user_id');
                if (savedUserId) {
                    return {
                        id: savedUserId,
                        username: getCookie('tg_username') || 'test_user',
                        first_name: getCookie('tg_name') || '–ò–≥—Ä–æ–∫',
                        last_name: '',
                        display_name: getCookie('tg_name') || '–ò–≥—Ä–æ–∫',
                        language_code: 'ru'
                    };
                }

                // Fallback –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                const fallbackId = Date.now().toString();
                return {
                    id: fallbackId,
                    username: 'test_user',
                    first_name: '–¢–µ—Å—Ç–æ–≤—ã–π',
                    last_name: '–ò–≥—Ä–æ–∫',
                    display_name: '–¢–µ—Å—Ç–æ–≤—ã–π –∏–≥—Ä–æ–∫',
                    language_code: 'ru'
                };
            } catch (error) {
                console.log('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                const fallbackId = Date.now().toString();
                return {
                    id: fallbackId,
                    username: 'test_user',
                    first_name: '–¢–µ—Å—Ç–æ–≤—ã–π',
                    last_name: '–ò–≥—Ä–æ–∫',
                    display_name: '–¢–µ—Å—Ç–æ–≤—ã–π –∏–≥—Ä–æ–∫',
                    language_code: 'ru'
                };
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ cookies
        function saveUserData(userData) {
            setCookie('tg_user_id', userData.id);
            setCookie('tg_username', userData.username);
            setCookie('tg_name', userData.display_name);
            setCookie('tg_language', userData.language_code);
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ D1
        async function getUserData(userId) {
            try {
                console.log('–ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è ID:', userId);
                console.log('URL –∑–∞–ø—Ä–æ—Å–∞:', `${config.baseUrl}/api/user?user_id=${userId}`);
                
                const data = await makeApiRequest(`/api/user?user_id=${userId}`, { method: 'GET' });
                console.log('–û—Ç–≤–µ—Ç –æ—Ç API –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', data);
                return data.success ? data.user : null;
            } catch (error) {
                console.log('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:');
                console.log('Error message:', error.message);
                console.log('Error stack:', error.stack);
                console.log('Full error:', error);
                return null;
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ D1
        async function createUser(userData) {
            try {
                const newUserData = {
                    user_id: userData.id,
                    user_name: userData.display_name,
                    money: 100,
                    card: ''
                };

                console.log('–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –¥–∞–Ω–Ω—ã–º–∏:', newUserData);
                console.log('URL –∑–∞–ø—Ä–æ—Å–∞:', `${config.baseUrl}/api/user`);

                const result = await makeApiRequest('/api/user', {
                    method: 'POST',
                    body: JSON.stringify(newUserData)
                });

                console.log('–û—Ç–≤–µ—Ç –æ—Ç API –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', result);
                return result.success ? result.user : null;
            } catch (error) {
                console.log('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:');
                console.log('Error message:', error.message);
                console.log('Error stack:', error.stack);
                console.log('Full error:', error);
                throw error;
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ D1
        async function updateUserData(userId, updates) {
            try {
                const result = await makeApiRequest('/api/user', {
                    method: 'PUT',
                    body: JSON.stringify({ user_id: userId, ...updates })
                });

                return result.success ? result.user : null;
            } catch (error) {
                console.log('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                throw error;
            }
        }

        // –ü–æ–ª—É—á–∏—Ç—å –∞–≤–∞—Ç–∞—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function getUserAvatar(userData) {
            const photoElement = document.getElementById('userPhoto');
            const initialElement = document.getElementById('userInitial');
            
            if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user && tg.initDataUnsafe.user.photo_url) {
                photoElement.src = tg.initDataUnsafe.user.photo_url;
                photoElement.style.display = 'block';
                initialElement.style.display = 'none';
                return;
            }
            
            if (userData.first_name) {
                initialElement.textContent = userData.first_name.charAt(0).toUpperCase();
            } else {
                initialElement.textContent = 'üë§';
            }
            photoElement.style.display = 'none';
            initialElement.style.display = 'block';
        }

        // –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–æ–∫
        function enableButtonsAfterDelay() {
            setTimeout(() => {
                document.querySelectorAll('.btn').forEach(btn => {
                    btn.style.pointerEvents = 'auto';
                    btn.style.opacity = '1';
                });
            }, 500); // –£–º–µ–Ω—å—à–∏–ª–∏ —Å 1000–º—Å –¥–æ 500–º—Å
        }

        function disableButtons() {
            document.querySelectorAll('.btn').forEach(btn => {
                btn.style.pointerEvents = 'none';
                btn.style.opacity = '0.5';
            });
        }

        // –¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
        async function testApiConnection() {
            try {
                console.log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API...');
                const response = await fetch(config.baseUrl);
                console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ –æ—Ç API:', response.status);
                console.log('Headers –æ—Ç–≤–µ—Ç–∞:', [...response.headers.entries()]);
                
                if (!response.ok) {
                    console.log('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –û—Ç–≤–µ—Ç:', await response.text());
                    return false;
                }
                return true;
            } catch (error) {
                console.log('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
                return false;
            }
        }

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        async function checkUserInDatabase(userData) {
            const currencyDisplay = document.querySelector('.currency-display');
            currencyDisplay.classList.add('loading');

            try {
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API
                const apiAvailable = await testApiConnection();
                if (!apiAvailable) {
                    console.log('API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö');
                    currencyDisplay.classList.remove('loading');
                    document.getElementById('userMoney').textContent = 0;
                    return false;
                }

                let existingUser = await getUserData(userData.id);

                if (existingUser) {
                    currencyDisplay.classList.remove('loading');
                    document.getElementById('userMoney').textContent = existingUser.money || 0;
                    return true;
                }

                // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                const createdUser = await createUser(userData);
                if (createdUser) {
                    currencyDisplay.classList.remove('loading');
                    document.getElementById('userMoney').textContent = 100;
                    return true;
                }

            } catch (error) {
                console.log('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö:');
                console.log('Error message:', error.message);
                console.log('Error stack:', error.stack);
                console.log('Full error:', error);
                currencyDisplay.classList.remove('loading');
                document.getElementById('userMoney').textContent = 0;
            }
            
            return true;
        }

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function initApp() {
            if (isInitialized) return;
            
            try {
                disableButtons();

                if (window.Telegram && window.Telegram.WebApp) {
                    tg.ready();
                    userData = getTelegramUserData();
                    saveUserData(userData);
                    getUserAvatar(userData);
                    await checkUserInDatabase(userData);
                }

                isInitialized = true;
                enableButtonsAfterDelay();

            } catch (error) {
                console.log('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                const currencyDisplay = document.querySelector('.currency-display');
                currencyDisplay.classList.remove('loading');
                document.getElementById('userMoney').textContent = 0;
                getUserAvatar(userData || {});
                enableButtonsAfterDelay();
                isInitialized = true;
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
        setInterval(() => {
            const now = Date.now();
            for (const [key, value] of requestCache.entries()) {
                if (now - value.timestamp > config.cacheTimeout) {
                    requestCache.delete(key);
                }
            }
        }, 300000);

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', initApp);
        
        // –£–±–∏—Ä–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ window.load
        if (document.readyState === 'complete') {
            initApp();
        }
    </script>
</body>
</html>
