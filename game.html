
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hockey Shootouts - –ò–≥—Ä–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            color: white;
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        .balance {
            background: rgba(231,76,60,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid #e74c3c;
        }

        .game-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .room-section {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .players-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            margin: 20px 0;
        }

        .player-card {
            text-align: center;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            border: 2px solid transparent;
        }

        .player-card.occupied {
            border-color: #27ae60;
            background: rgba(39,174,96,0.1);
        }

        .player-card.empty {
            border-color: #f39c12;
            border-style: dashed;
            background: rgba(243,156,18,0.1);
        }

        .player-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 2px solid #e74c3c;
            overflow: hidden;
        }

        .player-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .vs-text {
            font-size: 24px;
            font-weight: bold;
            color: #e74c3c;
        }

        .btn {
            background: linear-gradient(45deg, #e74c3c, #ff6b5b);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231,76,60,0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .game-section {
            display: none;
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .scoreboard {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
            text-align: center;
        }

        .score-display {
            font-size: 32px;
            font-weight: bold;
            color: #f39c12;
        }

        .game-info {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        .timer {
            font-size: 28px;
            font-weight: bold;
            color: #f39c12;
            margin: 10px 0;
        }

        .areas-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 15px;
            max-width: 300px;
            margin: 20px auto;
        }

        .area {
            height: 70px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            background: rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }

        .area:hover {
            border-color: #e74c3c;
            background: rgba(231,76,60,0.2);
        }

        .area.selected {
            background: #f39c12;
            border-color: #f39c12;
            color: #000;
        }

        .area.goal {
            background: #27ae60;
            border-color: #27ae60;
        }

        .area.save {
            background: #e74c3c;
            border-color: #e74c3c;
        }

        .area.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #e74c3c;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: #2c3e50;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 300px;
            border: 2px solid #e74c3c;
        }

        .result-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.4);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 20px;
            cursor: pointer;
        }

        .selected-count {
            text-align: center;
            margin-bottom: 10px;
            color: #f39c12;
            font-weight: bold;
        }

        @media (max-width: 600px) {
            .players-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .vs-text { display: none; }
            .scoreboard {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <button class="back-btn" onclick="window.location.href='index.html'">‚Üê</button>
    
    <div class="notification" id="notification"></div>

    <div class="header">
        <h1>Hockey Shootouts</h1>
        <div class="balance" id="balance">–ö–ª—é—à–µ–∫: 0 üèí</div>
    </div>

    <div class="game-container">
        <!-- –°–µ–∫—Ü–∏—è –ª–æ–±–±–∏ -->
        <div class="room-section" id="lobby-section">
            <h2 style="text-align: center; color: #e74c3c;">–ì–ª–∞–≤–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞</h2>
            <p style="text-align: center; color: #bdc3c7;">–ë—ã—Å—Ç—Ä–∞—è –∏–≥—Ä–∞ –Ω–∞ 1 –∫–ª—é—à–∫—É</p>

            <div class="players-grid">
                <div class="player-card empty" id="player1-slot">
                    <div class="player-avatar" id="player1-avatar">‚ùì</div>
                    <div id="player1-name">–°–≤–æ–±–æ–¥–Ω–æ</div>
                    <small style="color: #bdc3c7;">–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞</small>
                </div>

                <div class="vs-text">VS</div>

                <div class="player-card empty" id="player2-slot">
                    <div class="player-avatar" id="player2-avatar">‚ùì</div>
                    <div id="player2-name">–°–≤–æ–±–æ–¥–Ω–æ</div>
                    <small style="color: #bdc3c7;">–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞</small>
                </div>
            </div>

            <div style="text-align: center;">
                <div style="background: rgba(243,156,18,0.1); padding: 10px; border-radius: 10px; margin: 15px 0; border: 1px solid #f39c12;">
                    <strong style="color: #f39c12;">üèí –°—Ç–∞–≤–∫–∞: 1 –∫–ª—é—à–∫–∞</strong>
                </div>
                <button class="btn" id="action-btn" disabled>–ó–∞–≥—Ä—É–∑–∫–∞...</button>
                <div id="room-status" style="margin-top: 10px; color: #bdc3c7;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è –∏–≥—Ä—ã -->
        <div class="game-section" id="game-section">
            <div class="scoreboard">
                <div>
                    <div class="player-avatar" id="game-player1-avatar">üë§</div>
                    <div id="game-player1-name">–ò–≥—Ä–æ–∫ 1</div>
                    <div class="score-display" id="player1-score">0</div>
                </div>
                
                <div class="score-display">:</div>
                
                <div>
                    <div class="player-avatar" id="game-player2-avatar">üë§</div>
                    <div id="game-player2-name">–ò–≥—Ä–æ–∫ 2</div>
                    <div class="score-display" id="player2-score">0</div>
                </div>
            </div>

            <div class="game-info">
                <div id="game-status">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</div>
                <div class="timer" id="timer-display">10</div>
                <div id="turn-indicator" style="color: #bdc3c7;"></div>
            </div>

            <!-- –§–∞–∑–∞ –∞—Ç–∞–∫–∏ -->
            <div id="shoot-phase" style="display: none;">
                <h3 style="text-align: center; color: #e74c3c;">‚öΩ –í—ã–±–µ—Ä–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å –¥–ª—è —É–¥–∞—Ä–∞</h3>
                <div class="areas-grid" id="goal-areas">
                    <div class="area" data-area="1">–í–µ—Ä—Ö –ª–µ–≤–æ</div>
                    <div class="area" data-area="2">–í–µ—Ä—Ö –ø—Ä–∞–≤–æ</div>
                    <div class="area" data-area="3">–ù–∏–∑ –ª–µ–≤–æ</div>
                    <div class="area" data-area="4">–ù–∏–∑ –ø—Ä–∞–≤–æ</div>
                </div>
            </div>

            <!-- –§–∞–∑–∞ –∑–∞—â–∏—Ç—ã -->
            <div id="defend-phase" style="display: none;">
                <h3 style="text-align: center; color: #e74c3c;">üõ°Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ 2 –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏</h3>
                <div class="selected-count">–í—ã–±—Ä–∞–Ω–æ: <span id="selected-count">0</span>/2</div>
                <div class="areas-grid" id="defense-areas">
                    <div class="area" data-area="1">–í–µ—Ä—Ö –ª–µ–≤–æ</div>
                    <div class="area" data-area="2">–í–µ—Ä—Ö –ø—Ä–∞–≤–æ</div>
                    <div class="area" data-area="3">–ù–∏–∑ –ª–µ–≤–æ</div>
                    <div class="area" data-area="4">–ù–∏–∑ –ø—Ä–∞–≤–æ</div>
                </div>
            </div>

            <!-- –û–∂–∏–¥–∞–Ω–∏–µ -->
            <div id="waiting-phase">
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 40px; margin-bottom: 15px;">‚è≥</div>
                    <div id="waiting-text">–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...</div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" id="confirm-action-btn" style="display: none;">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                <button class="btn btn-secondary" id="back-to-lobby-btn" onclick="backToLobby()">üö™ –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ª–æ–±–±–∏</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div class="modal" id="result-modal">
        <div class="modal-content">
            <div class="result-icon" id="result-icon">‚öΩ</div>
            <div id="result-text" style="font-size: 24px; font-weight: bold; margin-bottom: 10px;">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
            <div id="result-description" style="color: #bdc3c7; margin-bottom: 20px;">–û–ø–∏—Å–∞–Ω–∏–µ</div>
            <button class="btn" id="result-ok-btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
        </div>
    </div>

    <div class="modal" id="final-result-modal">
        <div class="modal-content">
            <div class="result-icon" id="final-icon">üèÜ</div>
            <div id="final-text" style="font-size: 28px; font-weight: bold; margin-bottom: 15px;">–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</div>
            <div id="final-description" style="color: #bdc3c7; margin-bottom: 20px;">–û–ø–∏—Å–∞–Ω–∏–µ</div>
            <button class="btn" id="final-ok-btn">–í –ª–æ–±–±–∏</button>
        </div>
    </div>

    <script>
        // API –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const NOCODB_API = "https://app.nocodb.com/api/v1/db/data/weamcfo6/p27jdsmk69wuimh/meefo7wdwoh5mtv";
        const ROOM_API = "https://app.nocodb.com/api/v1/db/data/weamcfo6/p27jdsmk69wuimh/mznem6p3jztsgsl";
        const NOCODB_KEY = "bocQfycJpJsTG_tbwEf8ma8E5rhoig0njMDXFWtJ";

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        const tg = window.Telegram.WebApp;
        let currentUser = null;
        let gameRoom = null;
        let userBalance = 0;
        let refreshInterval = null;
        let timerInterval = null;
        let isOperationInProgress = false;

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        let gameState = {
            isMyTurn: false,
            phase: 'wait',
            selectedShootArea: null,
            selectedDefenseAreas: [],
            timeLeft: 10,
            isPlayer1: false,
            inGame: false
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            currentUser = tg.initDataUnsafe.user;
        } else {
            currentUser = {
                id: 12345,
                first_name: "–¢–µ—Å—Ç–æ–≤—ã–π",
                last_name: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
                username: "test_user"
            };
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        init();

        async function init() {
            await loadUserBalance();
            await initializeRoom();
            await loadRoom();
            refreshInterval = setInterval(loadRoom, 2000);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞
        async function loadUserBalance() {
            try {
                const response = await fetch(`${NOCODB_API}?where=(tg_user_id,eq,${currentUser.id})`, {
                    headers: { "xc-token": NOCODB_KEY }
                });
                const data = await response.json();
                if (data.list.length > 0) {
                    userBalance = data.list[0].point || 0;
                    document.getElementById('balance').textContent = `–ö–ª—é—à–µ–∫: ${userBalance} üèí`;
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –±–∞–ª–∞–Ω—Å–∞:", error);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–Ω–∞—Ç—ã
        async function initializeRoom() {
            try {
                const response = await fetch(`${ROOM_API}?where=(id_room,eq,main_room)`, {
                    headers: { "xc-token": NOCODB_KEY }
                });
                const data = await response.json();

                if (data.list.length === 0) {
                    await fetch(ROOM_API, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            "xc-token": NOCODB_KEY
                        },
                        body: JSON.stringify({
                            id_room: "main_room",
                            status: "empty",
                            bet: 1,
                            xp_p1: 0,
                            xp_p2: 0,
                            sec: 10,
                            turn: 1
                        })
                    });
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–º–Ω–∞—Ç—ã:", error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã
        async function loadRoom() {
            if (isOperationInProgress) return;

            try {
                const response = await fetch(`${ROOM_API}?where=(id_room,eq,main_room)`, {
                    headers: { "xc-token": NOCODB_KEY }
                });
                const data = await response.json();
                
                if (data.list.length > 0) {
                    gameRoom = data.list[0];
                    const isPlayer1 = gameRoom.player1_id == currentUser.id;
                    const isPlayer2 = gameRoom.player2_id == currentUser.id;
                    const isInGame = isPlayer1 || isPlayer2;

                    if (gameRoom.status === 'playing' && isInGame && !gameState.inGame) {
                        startGameMode();
                    } else if (!gameState.inGame) {
                        updateLobbyDisplay();
                    } else {
                        updateGameDisplay();
                    }
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–º–Ω–∞—Ç—ã:", error);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–±–±–∏
        function updateLobbyDisplay() {
            const statusEl = document.getElementById('room-status');
            const actionBtn = document.getElementById('action-btn');
            
            updatePlayerSlot(1, gameRoom.player1_id, gameRoom.player1_name, gameRoom.player1_avatar);
            updatePlayerSlot(2, gameRoom.player2_id, gameRoom.player2_name, gameRoom.player2_avatar);

            const isPlayer1 = gameRoom.player1_id == currentUser.id;
            const isPlayer2 = gameRoom.player2_id == currentUser.id;
            const isInGame = isPlayer1 || isPlayer2;

            if (gameRoom.status === 'empty') {
                statusEl.textContent = '–ö–æ–º–Ω–∞—Ç–∞ –ø—É—Å—Ç–∞';
                setupJoinButton(actionBtn);
            } else if (gameRoom.status === 'waiting') {
                if (isInGame) {
                    if (!gameRoom.player2_id) {
                        statusEl.textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞';
                        setupLeaveButton(actionBtn);
                    } else {
                        statusEl.textContent = '–ì–æ—Ç–æ–≤ –∫ –∏–≥—Ä–µ';
                        setupStartButton(actionBtn);
                    }
                } else {
                    if (!gameRoom.player2_id) {
                        statusEl.textContent = '–ï—Å—Ç—å —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ';
                        setupJoinButton(actionBtn);
                    } else {
                        statusEl.textContent = '–ò–≥—Ä–æ–∫–∏ –≥–æ—Ç–æ–≤—è—Ç—Å—è';
                        actionBtn.innerHTML = '–û–∂–∏–¥–∞–Ω–∏–µ...';
                        actionBtn.disabled = true;
                    }
                }
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ª–æ—Ç–∞ –∏–≥—Ä–æ–∫–∞
        function updatePlayerSlot(playerNum, playerId, playerName, playerAvatar) {
            const slot = document.getElementById(`player${playerNum}-slot`);
            const avatar = document.getElementById(`player${playerNum}-avatar`);
            const name = document.getElementById(`player${playerNum}-name`);

            if (playerId) {
                slot.className = 'player-card occupied';
                avatar.innerHTML = playerAvatar ? 
                    `<img src="${playerAvatar}" alt="–ê–≤–∞—Ç–∞—Ä" onerror="this.parentElement.innerHTML='üë§'">` : 
                    'üë§';
                name.textContent = playerName || '–ò–≥—Ä–æ–∫';
            } else {
                slot.className = 'player-card empty';
                avatar.innerHTML = '‚ùì';
                name.textContent = '–°–≤–æ–±–æ–¥–Ω–æ';
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫
        function setupJoinButton(btn) {
            if (userBalance < 1) {
                btn.innerHTML = '‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–ª—é—à–µ–∫';
                btn.disabled = true;
            } else {
                btn.innerHTML = 'üéÆ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è';
                btn.disabled = false;
                btn.onclick = joinRoom;
            }
        }

        function setupLeaveButton(btn) {
            btn.innerHTML = 'üö™ –ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É';
            btn.disabled = false;
            btn.onclick = leaveRoom;
        }

        function setupStartButton(btn) {
            btn.innerHTML = 'üéÆ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É';
            btn.disabled = false;
            btn.onclick = startGame;
        }

        // –î–µ–π—Å—Ç–≤–∏—è –ª–æ–±–±–∏
        async function joinRoom() {
            if (isOperationInProgress || userBalance < 1) return;
            isOperationInProgress = true;

            try {
                const fullName = `${currentUser.first_name || ''} ${currentUser.last_name || ''}`.trim();
                const userAvatar = await getUserAvatar();
                let updateData = {};

                if (!gameRoom.player1_id) {
                    updateData = {
                        player1_id: currentUser.id,
                        player1_name: fullName,
                        player1_avatar: userAvatar,
                        status: "waiting"
                    };
                } else if (!gameRoom.player2_id) {
                    updateData = {
                        player2_id: currentUser.id,
                        player2_name: fullName,
                        player2_avatar: userAvatar,
                        status: "waiting"
                    };
                }

                await fetch(`${ROOM_API}/${gameRoom.Id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        "xc-token": NOCODB_KEY
                    },
                    body: JSON.stringify(updateData)
                });

                showNotification('‚úÖ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∏–≥—Ä–µ!');
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏:", error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            } finally {
                isOperationInProgress = false;
            }
        }

        async function leaveRoom() {
            if (isOperationInProgress) return;
            isOperationInProgress = true;

            try {
                const isPlayer1 = gameRoom.player1_id == currentUser.id;
                let updateData = {};

                if (isPlayer1) {
                    if (gameRoom.player2_id) {
                        updateData = {
                            player1_id: gameRoom.player2_id,
                            player1_name: gameRoom.player2_name,
                            player1_avatar: gameRoom.player2_avatar,
                            player2_id: null,
                            player2_name: null,
                            player2_avatar: null,
                            status: "waiting"
                        };
                    } else {
                        updateData = {
                            player1_id: null,
                            player1_name: null,
                            player1_avatar: null,
                            status: "empty"
                        };
                    }
                } else {
                    updateData = {
                        player2_id: null,
                        player2_name: null,
                        player2_avatar: null,
                        status: gameRoom.player1_id ? "waiting" : "empty"
                    };
                }

                await fetch(`${ROOM_API}/${gameRoom.Id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        "xc-token": NOCODB_KEY
                    },
                    body: JSON.stringify(updateData)
                });

                showNotification('üö™ –ü–æ–∫–∏–Ω—É–ª–∏ –∫–æ–º–Ω–∞—Ç—É');
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:", error);
            } finally {
                isOperationInProgress = false;
            }
        }

        async function startGame() {
            if (isOperationInProgress) return;
            isOperationInProgress = true;

            try {
                await deductBets();
                await fetch(`${ROOM_API}/${gameRoom.Id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        "xc-token": NOCODB_KEY
                    },
                    body: JSON.stringify({
                        status: "playing",
                        xp_p1: 0,
                        xp_p2: 0,
                        sec: 10,
                        send: null,
                        block: null,
                        turn: 1
                    })
                });

                startGameMode();
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –∏–≥—Ä—ã:", error);
            } finally {
                isOperationInProgress = false;
            }
        }

        async function deductBets() {
            const promises = [];

            for (const playerId of [gameRoom.player1_id, gameRoom.player2_id]) {
                const response = await fetch(`${NOCODB_API}?where=(tg_user_id,eq,${playerId})`, {
                    headers: { "xc-token": NOCODB_KEY }
                });
                const data = await response.json();
                if (data.list.length > 0) {
                    promises.push(
                        fetch(`${NOCODB_API}/${data.list[0].Id}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                "xc-token": NOCODB_KEY
                            },
                            body: JSON.stringify({
                                point: Math.max(0, (data.list[0].point || 0) - 1)
                            })
                        })
                    );
                }
            }

            await Promise.all(promises);
            await loadUserBalance();
        }

        async function getUserAvatar() {
            try {
                const response = await fetch(`${NOCODB_API}?where=(tg_user_id,eq,${currentUser.id})`, {
                    headers: { "xc-token": NOCODB_KEY }
                });
                const data = await response.json();
                return data.list.length > 0 ? (data.list[0].avatar || '') : '';
            } catch (error) {
                return '';
            }
        }

        // –ò–≥—Ä–æ–≤–∞—è –ª–æ–≥–∏–∫–∞
        function startGameMode() {
            gameState.inGame = true;
            gameState.isPlayer1 = gameRoom.player1_id == currentUser.id;
            
            document.getElementById('lobby-section').style.display = 'none';
            document.getElementById('game-section').style.display = 'block';

            updatePlayerInfo();
            updateGameState();
            startTimer();
        }

        function updatePlayerInfo() {
            document.getElementById('game-player1-name').textContent = gameRoom.player1_name || '–ò–≥—Ä–æ–∫ 1';
            document.getElementById('game-player2-name').textContent = gameRoom.player2_name || '–ò–≥—Ä–æ–∫ 2';
            
            setPlayerAvatar('game-player1-avatar', gameRoom.player1_avatar);
            setPlayerAvatar('game-player2-avatar', gameRoom.player2_avatar);

            document.getElementById('player1-score').textContent = gameRoom.xp_p1 || 0;
            document.getElementById('player2-score').textContent = gameRoom.xp_p2 || 0;
        }

        function setPlayerAvatar(elementId, avatarUrl) {
            const element = document.getElementById(elementId);
            if (avatarUrl) {
                element.innerHTML = `<img src="${avatarUrl}" alt="–ê–≤–∞—Ç–∞—Ä" onerror="this.parentElement.innerHTML='üë§'">`;
            } else {
                element.innerHTML = 'üë§';
            }
        }

        function updateGameState() {
            gameState.timeLeft = gameRoom.sec || 10;

            if (gameRoom.send === null && gameRoom.block === null) {
                gameState.phase = 'shoot';
                gameState.isMyTurn = (gameState.isPlayer1 && gameRoom.turn === 1) || (!gameState.isPlayer1 && gameRoom.turn === 2);
            } else if (gameRoom.send !== null && gameRoom.block === null) {
                gameState.phase = 'defend';
                gameState.isMyTurn = (gameState.isPlayer1 && gameRoom.turn === 2) || (!gameState.isPlayer1 && gameRoom.turn === 1);
            } else if (gameRoom.send !== null && gameRoom.block !== null) {
                gameState.phase = 'result';
                showRoundResult();
                return;
            }

            updateGameUI();
        }

        function updateGameUI() {
            document.getElementById('timer-display').textContent = gameState.timeLeft;
            
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ —Ñ–∞–∑—ã
            document.getElementById('shoot-phase').style.display = 'none';
            document.getElementById('defend-phase').style.display = 'none';
            document.getElementById('waiting-phase').style.display = 'none';

            if (gameState.isMyTurn) {
                if (gameState.phase === 'shoot') {
                    document.getElementById('game-status').textContent = '–í–∞—à —Ö–æ–¥ - –ê–¢–ê–ö–ê';
                    document.getElementById('turn-indicator').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å –¥–ª—è —É–¥–∞—Ä–∞';
                    document.getElementById('shoot-phase').style.display = 'block';
                } else if (gameState.phase === 'defend') {
                    document.getElementById('game-status').textContent = '–í–∞—à —Ö–æ–¥ - –ó–ê–©–ò–¢–ê';
                    document.getElementById('turn-indicator').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ 2 –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏';
                    document.getElementById('defend-phase').style.display = 'block';
                }
            } else {
                document.getElementById('waiting-phase').style.display = 'block';
                if (gameState.phase === 'shoot') {
                    document.getElementById('game-status').textContent = '–•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ - –ê–¢–ê–ö–ê';
                    document.getElementById('turn-indicator').textContent = '–°–æ–ø–µ—Ä–Ω–∏–∫ –≤—ã–±–∏—Ä–∞–µ—Ç –æ–±–ª–∞—Å—Ç—å –∞—Ç–∞–∫–∏';
                    document.getElementById('waiting-text').textContent = '–°–æ–ø–µ—Ä–Ω–∏–∫ –±—å–µ—Ç...';
                } else if (gameState.phase === 'defend') {
                    document.getElementById('game-status').textContent = '–•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ - –ó–ê–©–ò–¢–ê';
                    document.getElementById('turn-indicator').textContent = '–°–æ–ø–µ—Ä–Ω–∏–∫ –≤—ã–±–∏—Ä–∞–µ—Ç –∑–∞—â–∏—Ç—É';
                    document.getElementById('waiting-text').textContent = '–°–æ–ø–µ—Ä–Ω–∏–∫ –∑–∞—â–∏—â–∞–µ—Ç—Å—è...';
                }
            }

            clearSelections();
        }

        function updateGameDisplay() {
            if (!gameState.inGame) return;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏–≥—Ä—ã
            if (gameRoom.xp_p1 >= 3 || gameRoom.xp_p2 >= 3) {
                endGame();
                return;
            }

            updatePlayerInfo();
            updateGameState();
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(async () => {
                if (gameState.timeLeft > 0) {
                    gameState.timeLeft--;
                    document.getElementById('timer-display').textContent = gameState.timeLeft;
                    
                    if (gameState.isMyTurn) {
                        try {
                            await fetch(`${ROOM_API}/${gameRoom.Id}`, {
                                method: 'PATCH',
                                headers: {
                                    'Content-Type': 'application/json',
                                    "xc-token": NOCODB_KEY
                                },
                                body: JSON.stringify({ sec: gameState.timeLeft })
                            });
                        } catch (error) {
                            console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞:", error);
                        }
                    }
                } else {
                    clearInterval(timerInterval);
                    if (gameState.isMyTurn) {
                        await handleTimeOut();
                    }
                }
            }, 1000);
        }

        async function handleTimeOut() {
            if (gameState.phase === 'shoot') {
                const randomArea = Math.floor(Math.random() * 4) + 1;
                gameState.selectedShootArea = randomArea;
                await submitShootAction();
            } else if (gameState.phase === 'defend') {
                const areas = [1, 2, 3, 4];
                const selectedAreas = [];
                for (let i = 0; i < 2; i++) {
                    const randomIndex = Math.floor(Math.random() * areas.length);
                    selectedAreas.push(areas[randomIndex]);
                    areas.splice(randomIndex, 1);
                }
                gameState.selectedDefenseAreas = selectedAreas;
                await submitDefendAction();
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–≥—Ä—ã
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('area') && gameState.inGame) {
                const area = parseInt(e.target.getAttribute('data-area'));
                
                if (gameState.phase === 'shoot' && gameState.isMyTurn) {
                    selectShootArea(area);
                } else if (gameState.phase === 'defend' && gameState.isMyTurn) {
                    selectDefendArea(area);
                }
            }
        });

        function selectShootArea(area) {
            clearSelections();
            gameState.selectedShootArea = area;
            
            const areaElement = document.querySelector(`#goal-areas [data-area="${area}"]`);
            areaElement.classList.add('selected');
            
            document.getElementById('confirm-action-btn').style.display = 'block';
        }

        function selectDefendArea(area) {
            const areaElement = document.querySelector(`#defense-areas [data-area="${area}"]`);
            
            if (areaElement.classList.contains('selected')) {
                areaElement.classList.remove('selected');
                gameState.selectedDefenseAreas = gameState.selectedDefenseAreas.filter(a => a !== area);
            } else {
                if (gameState.selectedDefenseAreas.length < 2) {
                    areaElement.classList.add('selected');
                    gameState.selectedDefenseAreas.push(area);
                }
            }

            document.getElementById('selected-count').textContent = gameState.selectedDefenseAreas.length;
            
            if (gameState.selectedDefenseAreas.length === 2) {
                document.getElementById('confirm-action-btn').style.display = 'block';
            } else {
                document.getElementById('confirm-action-btn').style.display = 'none';
            }
        }

        function clearSelections() {
            document.querySelectorAll('.area').forEach(area => {
                area.classList.remove('selected', 'goal', 'save');
            });
            gameState.selectedShootArea = null;
            gameState.selectedDefenseAreas = [];
            document.getElementById('selected-count').textContent = '0';
            document.getElementById('confirm-action-btn').style.display = 'none';
        }

        async function submitShootAction() {
            try {
                await fetch(`${ROOM_API}/${gameRoom.Id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        "xc-token": NOCODB_KEY
                    },
                    body: JSON.stringify({
                        send: gameState.selectedShootArea,
                        sec: 10,
                        turn: gameState.isPlayer1 ? 2 : 1
                    })
                });

                gameState.isMyTurn = false;
                updateGameUI();
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–¥–∞—Ä–∞:", error);
            }
        }

        async function submitDefendAction() {
            try {
                const blockValue = parseInt(gameState.selectedDefenseAreas.sort().join(''));
                
                await fetch(`${ROOM_API}/${gameRoom.Id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        "xc-token": NOCODB_KEY
                    },
                    body: JSON.stringify({
                        block: blockValue
                    })
                });

                gameState.isMyTurn = false;
                updateGameUI();
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—â–∏—Ç—ã:", error);
            }
        }

        function showRoundResult() {
            const shootArea = gameRoom.send;
            const blockAreas = gameRoom.block.toString().split('').map(n => parseInt(n));
            const isGoal = !blockAreas.includes(shootArea);

            // –í–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            document.querySelectorAll('.area').forEach(area => {
                const areaNumber = parseInt(area.getAttribute('data-area'));
                if (areaNumber === shootArea) {
                    area.classList.add(isGoal ? 'goal' : 'save');
                }
                if (blockAreas.includes(areaNumber)) {
                    area.classList.add('selected');
                }
            });

            // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = document.getElementById('result-modal');
            const icon = document.getElementById('result-icon');
            const text = document.getElementById('result-text');
            const description = document.getElementById('result-description');

            if (isGoal) {
                icon.textContent = '‚öΩ';
                icon.style.color = '#27ae60';
                text.textContent = '–ì–û–õ!';
                text.style.color = '#27ae60';
                description.textContent = '–£–¥–∞—Ä –ø—Ä–æ—à–µ–ª –º–∏–º–æ –∑–∞—â–∏—Ç—ã';
            } else {
                icon.textContent = 'üõ°Ô∏è';
                icon.style.color = '#e74c3c';
                text.textContent = '–°–ï–ô–í!';
                text.style.color = '#e74c3c';
                description.textContent = '–ó–∞—â–∏—Ç–Ω–∏–∫ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª —É–¥–∞—Ä';
            }

            modal.style.display = 'flex';
        }

        async function endGame() {
            if (timerInterval) clearInterval(timerInterval);
            
            const player1Wins = gameRoom.xp_p1 >= 3;
            const winnerId = player1Wins ? gameRoom.player1_id : gameRoom.player2_id;
            const winnerName = player1Wins ? gameRoom.player1_name : gameRoom.player2_name;
            const isWinner = winnerId == currentUser.id;
            const prize = 2;

            if (isWinner) {
                const response = await fetch(`${NOCODB_API}?where=(tg_user_id,eq,${winnerId})`, {
                    headers: { "xc-token": NOCODB_KEY }
                });
                const data = await response.json();
                if (data.list.length > 0) {
                    await fetch(`${NOCODB_API}/${data.list[0].Id}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            "xc-token": NOCODB_KEY
                        },
                        body: JSON.stringify({
                            point: (data.list[0].point || 0) + prize
                        })
                    });
                }
                await loadUserBalance();
            }

            // –°–±—Ä–æ—Å –∫–æ–º–Ω–∞—Ç—ã
            try {
                await fetch(`${ROOM_API}/${gameRoom.Id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        "xc-token": NOCODB_KEY
                    },
                    body: JSON.stringify({
                        player1_id: null,
                        player1_name: null,
                        player1_avatar: null,
                        player2_id: null,
                        player2_name: null,
                        player2_avatar: null,
                        status: "empty",
                        xp_p1: 0,
                        xp_p2: 0,
                        sec: 10,
                        send: null,
                        block: null,
                        turn: 1
                    })
                });
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –∫–æ–º–Ω–∞—Ç—ã:", error);
            }

            // –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            const modal = document.getElementById('final-result-modal');
            const icon = document.getElementById('final-icon');
            const text = document.getElementById('final-text');
            const description = document.getElementById('final-description');

            if (isWinner) {
                icon.textContent = 'üèÜ';
                icon.style.color = '#f39c12';
                text.textContent = '–ü–û–ë–ï–î–ê!';
                text.style.color = '#27ae60';
                description.textContent = `–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ ${prize} –∫–ª—é—à–µ–∫! –°—á–µ—Ç: ${gameRoom.xp_p1}:${gameRoom.xp_p2}`;
            } else {
                icon.textContent = 'üíî';
                icon.style.color = '#e74c3c';
                text.textContent = '–ü–û–†–ê–ñ–ï–ù–ò–ï';
                text.style.color = '#e74c3c';
                description.textContent = `–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${winnerName}. –°—á–µ—Ç: ${gameRoom.xp_p1}:${gameRoom.xp_p2}`;
            }

            modal.style.display = 'flex';
        }

        function backToLobby() {
            gameState.inGame = false;
            document.getElementById('game-section').style.display = 'none';
            document.getElementById('lobby-section').style.display = 'block';
            if (timerInterval) clearInterval(timerInterval);
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('confirm-action-btn').addEventListener('click', async () => {
            if (gameState.phase === 'shoot' && gameState.selectedShootArea) {
                await submitShootAction();
            } else if (gameState.phase === 'defend' && gameState.selectedDefenseAreas.length === 2) {
                await submitDefendAction();
            }
        });

        document.getElementById('result-ok-btn').addEventListener('click', async () => {
            document.getElementById('result-modal').style.display = 'none';
            
            const shooterWon = !gameRoom.block.toString().split('').map(n => parseInt(n)).includes(gameRoom.send);
            const isPlayer1Shooter = gameRoom.turn === 1;
            
            let updateData = {
                send: null,
                block: null,
                sec: 10,
                turn: isPlayer1Shooter ? 2 : 1
            };

            if (shooterWon) {
                if (isPlayer1Shooter) {
                    updateData.xp_p1 = (gameRoom.xp_p1 || 0) + 1;
                } else {
                    updateData.xp_p2 = (gameRoom.xp_p2 || 0) + 1;
                }
            } else {
                if (isPlayer1Shooter) {
                    updateData.xp_p2 = (gameRoom.xp_p2 || 0) + 1;
                } else {
                    updateData.xp_p1 = (gameRoom.xp_p1 || 0) + 1;
                }
            }

            try {
                await fetch(`${ROOM_API}/${gameRoom.Id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        "xc-token": NOCODB_KEY
                    },
                    body: JSON.stringify(updateData)
                });
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —Ä–∞—É–Ω–¥–∞:", error);
            }
        });

        document.getElementById('final-ok-btn').addEventListener('click', () => {
            backToLobby();
            document.getElementById('final-result-modal').style.display = 'none';
        });

        window.addEventListener('beforeunload', () => {
            if (refreshInterval) clearInterval(refreshInterval);
            if (timerInterval) clearInterval(timerInterval);
        });
    </script>
</body>
</html>
